---
title: "PRACTICA - 2"
author: "Autor"
date: '`r format(Sys.Date(),"%e de %B, %Y")`'
output:
  pdf_document: 
    toc: yes
    toc_depth: 2
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load_libraries, include=FALSE}
library(tidyverse)
library(data.table)


library(ggpubr)
library(cowplot)
library(stats)
library(agricolae)



library(knitr)
```

```{r general, include=FALSE}
mypalette<-c("#F8766D","#00BFC4","#7CAE00","#C77CFF","#D89000" )
```

## 1. Descripció del dataset

Per a la realització d'aquesta segona pràctica s'utilitza el *dataset* generat a la primera pràctica, i es combina amb altres *datasets* que resultin d'interès, per poder realitzar un anàlisis més profund, tenint en compte factors socioeconòmics.

Per a la correcta execució del *script* és imprescindible definir la ruta on es troba l'arxiu **Practica_2.Rmd** com a *working directory*.

```{r, include=FALSE}
wd<-getwd()
datadir<-paste(dirname(wd), "data", sep="/")
```

A continuació procedeix a la lectura de l'arxiu de dades amb opcions, escollint el separador i el tipus de codificació.

```{r}
fueldata <- read.csv(paste(datadir, "FuelScraper", "dataset.csv", sep = "/"), 
                     encoding="UTF-8", sep=";")
summary(fueldata)
```

El primer anàlisi del dataset indica que pot ser interessant canviar algunes dades a tipus factor.

```{r}
#Vector de variables a modificar
t_vector<-c("Province","Road_side","Sale_1", "Sale_2", "Fuel_type")

#Loop
for (i in t_vector){
  #Canvi de tipus a factor
  fueldata[,i]<-as.factor(fueldata[,i])
}
summary(fueldata)
```

Es canvia també el format de les variables temporals.

```{r}
fueldata$Capture_date<-as.Date(fueldata$Capture_date, format = "%Y/%m/%d")
fueldata$Update_date<-as.Date(fueldata$Update_date, format = "%d/%m/%Y")
fueldata$Capture_time<-lubridate::hms(fueldata$Capture_time)
```

Com a darrer pas en la càrrega del *dataset* original es generen variables de *backup* per a *Province* i *City* ja que aquestes posteriorment s'hauran de modificar a través de processos de normalització de noms per tal de fer-les compatibles amb les dades dels altres *datasets* a integrar.

```{r}
fueldata$bckup.Province<-fueldata$Province
fueldata$bckup.City<-fueldata$City
```

## 2. Integració i selecció

Amb l'objectiu d'obtenir un *dataset* amb més informació integrada, es llegeix un arxiu addicional amb el cens de població per municipis. Aquesta informació es extreta de l'Institut Nacional d'Estadística (INE). En aquest cas, la lectura també es realitza amb opcions.

```{r}
pobdata <- read.csv(paste(datadir, "pobmun", "pobmun22.csv", sep = "/"), 
                    encoding="UTF-8", sep=";")
```

Es canvien els noms de les variables i transformem les dades a majúscules per habilitar posteriors comparacions entre els dos *datasets*.

```{r}
#Canvis de noms
names(pobdata)[names(pobdata) == "PROVINCIA"] <- "Province"
names(pobdata)[names(pobdata) == "NOMBRE"] <- "City"
names(pobdata)[names(pobdata) == "CPRO"] <- "P_code"
names(pobdata)[names(pobdata) == "CMUN"] <- "C_code"
names(pobdata)[names(pobdata) == "POB22"] <- "Population"
names(pobdata)[names(pobdata) == "HOMBRES"] <- "P_Male"
names(pobdata)[names(pobdata) == "MUJERES"] <- "P_Female"

#Transformació a majúscules
pobdata$Province<-toupper(pobdata$Province)
pobdata$City<-toupper(pobdata$City)
```

Es normalitzen les paraules en les variables *Province* i *City* dels dos datasets, eliminant accénts i caràcters especials com la *ñ*. Per fer-ho es canvia el tipus de dades d'aquestes variables de UTF-8 a ASCII.

```{r}
fueldata$Province<-iconv(fueldata$Province, from = 'UTF-8', to = 'ASCII//TRANSLIT')
fueldata$City<-iconv(fueldata$City, from = 'UTF-8', to = 'ASCII//TRANSLIT')
pobdata$Province<-iconv(pobdata$Province, from = 'UTF-8', to = 'ASCII//TRANSLIT')
pobdata$City<-iconv(pobdata$City, from = 'UTF-8', to = 'ASCII//TRANSLIT')
```

Es canvia la denominació de 3 províncies per tal de fer la informació compatible entre els *datasets* de preus de combustibles i de població per municipis.

```{r}
fueldata[fueldata$Province=="ALICANTE","Province"]<-"ALICANTE/ALACANT"
fueldata[fueldata$Province=="VALENCIA / VALENCIA","Province"]<-"VALENCIA/VALENCIA"
fueldata[fueldata$Province=="CASTELLON / CASTELLO","Province"]<-"CASTELLON/CASTELLO"
```

A continuació es modifica l'ús d'articles en els camps *Province* i *City* utilitzant RegEx, també buscant la compatiblitat entre *datasets*.

```{r}
fueldata$Province<-sub("(\\w+) \\((\\w+)\\)","\\1, \\2",fueldata$Province, fixed=FALSE)
fueldata$City<-sub("((\\w| )+) \\(((\\w|')+)\\)","\\1, \\3",fueldata$City, fixed=FALSE)
```

Finalment es realitzen tot un seguit de canvis individuals (que no es mostren en la memòria, però si en el codi), per tal de maximitzar la informació disponible en el *dataset* resultant.

```{r, include=FALSE}
fueldata[fueldata$Province=="ALBACETE" & fueldata$City=="CHINCHILLA DE MONTE-ARAGO","City"]<-"CHINCHILLA DE MONTE-ARAGON"
fueldata[fueldata$Province=="ALICANTE/ALACANT" & fueldata$City=="BENITACHELL","City"]<-"BENITACHELL/POBLE NOU DE BENITATXELL, EL"
fueldata[fueldata$Province=="ALICANTE/ALACANT" & fueldata$City=="ALTEA LA VELLA","City"]<-"ALTEA"
fueldata[fueldata$Province=="ALICANTE/ALACANT" & fueldata$City=="CALPE","City"]<-"CALP"
fueldata[fueldata$Province=="ALICANTE/ALACANT" & fueldata$City=="HONDON DE LAS NIEVES","City"]<-"FONDO DE LES NEUS, EL/HONDON DE LAS NIEVES"
fueldata[fueldata$Province=="ALICANTE/ALACANT" & fueldata$City=="MONOVAR","City"]<-"MONOVAR/MONOVER"
fueldata[fueldata$Province=="ALICANTE/ALACANT" & fueldata$City=="MURO DEL ALCOY","City"]<-"MURO DE ALCOY"
fueldata[fueldata$Province=="ALICANTE/ALACANT" & fueldata$City=="ORIHUELA - COSTA, NUCLEO","City"]<-"ORIHUELA"
fueldata[fueldata$Province=="ALICANTE/ALACANT" & fueldata$City=="PINOSO","City"]<-"PINOS, EL/PINOSO"
fueldata[fueldata$Province=="ALICANTE/ALACANT" & fueldata$City=="VILLAJOYOSA / VILA JOIOSA, LA","City"]<-"VILLAJOYOSA/VILA JOIOSA, LA"
fueldata[fueldata$Province=="ALICANTE/ALACANT" & fueldata$City=="XIXONA","City"]<-"JIJONA/XIXONA"
fueldata[fueldata$Province=="AVILA" & fueldata$City=="MADRIGAL ALTAS TORRES","City"]<-"MADRIGAL DE LAS ALTAS TORRES"
fueldata[fueldata$Province=="AVILA" & fueldata$City=="SANTA M DE LOS CABALLEROS","City"]<-"SANTA MARIA DE LOS CABALLEROS"
fueldata[fueldata$Province=="BADAJOZ" & fueldata$City=="VALENCIA MOMBUEY","City"]<-"VALENCIA DEL MOMBUEY"
fueldata[fueldata$Province=="BARCELONA" & fueldata$City=="MONTCADA CENTRE","City"]<-"MONTCADA I REIXAC"
fueldata[fueldata$Province=="BARCELONA" & fueldata$City=="MONTORNES CENTRE","City"]<-"MONTORNES DEL VALLES"
fueldata[fueldata$Province=="BARCELONA" & fueldata$City=="MONTORNES NORD","City"]<-"MONTORNES DEL VALLES"
fueldata[fueldata$Province=="BARCELONA" & fueldata$City=="PALMA DE CERVELLO","City"]<-"PALMA DE CERVELLO, LA"
fueldata[fueldata$Province=="BARCELONA" & fueldata$City=="POBLE SEC","City"]<-"BARCELONA"
fueldata[fueldata$Province=="BARCELONA" & fueldata$City=="PONT VILOMARA I ROCAFORT","City"]<-"PONT DE VILOMARA I ROCAFORT, EL"
fueldata[fueldata$Province=="BARCELONA" & fueldata$City=="SANT FOST CAMPSENTELLES","City"]<-"SANT FOST DE CAMPSENTELLES"
fueldata[fueldata$Province=="BARCELONA" & fueldata$City=="SANT SALVADOR GUARDIOLA","City"]<-"SANT SALVADOR DE GUARDIOLA"
fueldata[fueldata$Province=="BARCELONA" & fueldata$City=="SANTA MARGARIDA MONTBUI","City"]<-"SANTA MARGARIDA DE MONTBUI"
fueldata[fueldata$Province=="BARCELONA" & fueldata$City=="TEIA CENTRE","City"]<-"TEIA"
fueldata[fueldata$Province=="BIZKAIA" & fueldata$City=="ABADINO-ZELAIETA","City"]<-"ABADINO"
fueldata[fueldata$Province=="BIZKAIA" & fueldata$City=="ABANTO","City"]<-"ABANTO Y CIERVANA-ABANTO ZIERBENAA"
fueldata[fueldata$Province=="BIZKAIA" & fueldata$City=="AMOREBIETA","City"]<-"AMOREBIETA-ETXANO"
fueldata[fueldata$Province=="BIZKAIA" & fueldata$City=="BERRIZ-OLAKUETA","City"]<-"BERRIZ"
fueldata[fueldata$Province=="BIZKAIA" & fueldata$City=="ORDUNA","City"]<-"URDUNA/ORDUNA"
fueldata[fueldata$Province=="BIZKAIA" & fueldata$City=="IZURZA","City"]<-"IZURTZA"
fueldata[fueldata$Province=="BURGOS" & fueldata$City=="HUERTA DEL REY","City"]<-"HUERTA DE REY"
fueldata[fueldata$Province=="CADIZ" & fueldata$City=="LINEA LA CONCEPCION, LA","City"]<-"LINEA DE LA CONCEPCION, LA"
fueldata[fueldata$Province=="CADIZ" & fueldata$City=="MEDINA-SIDONIA", "City"]<-"MEDINA SIDONIA"
fueldata[fueldata$Province=="CANTABRIA" & fueldata$City=="CASTRO URDIALES","City"]<-"CASTRO-URDIALES"
fueldata[fueldata$Province=="CANTABRIA" & fueldata$City=="CORRALES, LOS","City"]<-"CORRALES DE BUELNA, LOS"
fueldata[fueldata$Province=="CANTABRIA" & fueldata$City=="LOS CORRALES DE BUELNA","City"]<-"CORRALES DE BUELNA, LOS"
fueldata[fueldata$Province=="CASTELLON/CASTELLO" & fueldata$City=="ALCORA","City"]<-"ALCORA, L'"
fueldata[fueldata$Province=="CASTELLON/CASTELLO" & fueldata$City=="ALMAZORA","City"]<-"ALMASSORA"
fueldata[fueldata$Province=="CASTELLON/CASTELLO" & fueldata$City=="ALQUERIAS DEL NINO PERDIDO","City"]<-"ALQUERIES, LES/ALQUERIAS DEL NINO PERDIDO"
fueldata[fueldata$Province=="CASTELLON/CASTELLO" & fueldata$City=="BENASAL","City"]<-"BENASSAL"
fueldata[fueldata$Province=="CASTELLON/CASTELLO" & fueldata$City=="BENICASIM","City"]<-"BENICASIM/BENICASSIM"
fueldata[fueldata$Province=="CASTELLON/CASTELLO" & fueldata$City=="BENLLOCH","City"]<-"BENLLOC"
fueldata[fueldata$Province=="CASTELLON/CASTELLO" & fueldata$City=="BURRIANA","City"]<-"BORRIANA/BURRIANA"
fueldata[fueldata$Province=="CASTELLON/CASTELLO" & fueldata$City=="CASTELLON DE LA PLANA","City"]<-"CASTELLO DE LA PLANA"
fueldata[fueldata$Province=="CASTELLON/CASTELLO" & fueldata$City=="CHILCHES","City"]<-"CHILCHES/XILXES"
fueldata[fueldata$Province=="CASTELLON/CASTELLO" & fueldata$City=="LUCENA DEL CID","City"]<-"LLUCENA/LUCENA DEL CID"
fueldata[fueldata$Province=="CASTELLON/CASTELLO" & fueldata$City=="OROPESA","City"]<-"OROPESA DEL MAR/ORPESA"
fueldata[fueldata$Province=="CASTELLON/CASTELLO" & fueldata$City=="PENISCOLA","City"]<-"PENISCOLA/PENISCOLA"
fueldata[fueldata$Province=="CASTELLON/CASTELLO" & fueldata$City=="VILLAFRANCA DEL CID","City"]<-"VILAFRANCA/VILLAFRANCA DEL CID"
fueldata[fueldata$Province=="CASTELLON/CASTELLO" & fueldata$City=="VILLARREAL","City"]<-"VILA-REAL"
fueldata[fueldata$Province=="CASTELLON/CASTELLO" & fueldata$City=="VISTABELLA DEL MAESTRAZGO","City"]<-"VISTABELLA DEL MAESTRAT"
fueldata[fueldata$Province=="CIUDAD REAL" & fueldata$City=="VILLANUEVA LOS INFANTES","City"]<-"VILLANUEVA DE LOS INFANTES"
fueldata[fueldata$Province=="CORDOBA" & fueldata$City=="FERNAN NUNEZ","City"]<-"FERNAN-NUNEZ"
fueldata[fueldata$Province=="CORDOBA" & fueldata$City=="VALENZUELA Y LLANADAS","City"]<-"VALENZUELA"
fueldata[fueldata$Province=="CORUNA, A" & fueldata$City=="BETANZOS-O-VELLO","City"]<-"BETANZOS"
fueldata[fueldata$Province=="CORUNA, A" & fueldata$City=="LARACHA","City"]<-"LARACHA, A"
fueldata[fueldata$Province=="CORUNA, A" & fueldata$City=="OROSO PEQUENO","City"]<-"OROSO"
fueldata[fueldata$Province=="CORUNA, A" & fueldata$City=="POBRA DO CARAMINAL","City"]<-"POBRA DO CARAMINAL, A"
fueldata[fueldata$Province=="CORUNA, A" & fueldata$City=="PONTES DE GARCIA RODRIGUEZ, AS (SANTA MARIA)","City"]<-"PONTES DE GARCIA RODRIGUEZ, AS"
fueldata[fueldata$Province=="GIPUZKOA" & fueldata$City=="DONOSTIA-SAN SEBASTIAN","City"]<-"DONOSTIA/SAN SEBASTIAN"
fueldata[fueldata$Province=="GIPUZKOA" & fueldata$City=="LASARTE","City"]<-"LASARTE-ORIA"
fueldata[fueldata$Province=="GIRONA" & fueldata$City=="BISBAL D'EMPORDA(LA)","City"]<-"BISBAL D'EMPORDA, LA"
fueldata[fueldata$Province=="GIRONA" & fueldata$City=="BRUNYOLA","City"]<-"BRUNYOLA I SANT MARTI SAPRESA"
fueldata[fueldata$Province=="GIRONA" & fueldata$City=="CALONGE","City"]<-"CALONGE I SANT ANTONI"
fueldata[fueldata$Province=="GIRONA" & fueldata$City=="CASTELL D'ARO","City"]<-"CASTELL-PLATJA D'ARO"
fueldata[fueldata$Province=="GIRONA" & fueldata$City=="LA JONQUERA","City"]<-"JONQUERA, LA"
fueldata[fueldata$Province=="GIRONA" & fueldata$City=="LES PLANES D'HOSTOLES","City"]<-"PLANES D'HOSTOLES, LES"
fueldata[fueldata$Province=="GIRONA" & fueldata$City=="PEDRET","City"]<-"PEDRET I MARZA"
fueldata[fueldata$Province=="GIRONA" & fueldata$City=="PLATJA D'ARO","City"]<-"CASTELL-PLATJA D'ARO"
fueldata[fueldata$Province=="GIRONA" & fueldata$City=="ST JOAN DE LES ABADESSES","City"]<-"SANT JOAN DE LES ABADESSES"
fueldata[fueldata$Province=="GIRONA" & fueldata$City=="TOSSA","City"]<-"TOSSA DE MAR"
fueldata[fueldata$Province=="GRANADA" & fueldata$City=="GUEJAR-SIERRA","City"]<-"GUEJAR SIERRA"
fueldata[fueldata$Province=="GRANADA" & fueldata$City=="HUETOR-SANTILLAN","City"]<-"HUETOR DE SANTILLAN"
fueldata[fueldata$Province=="GRANADA" & fueldata$City=="HUETOR-TAJAR","City"]<-"HUETOR TAJAR"
fueldata[fueldata$Province=="GRANADA" & fueldata$City=="HUETOR-VEGA","City"]<-"HUETOR VEGA"
fueldata[fueldata$Province=="GRANADA" & fueldata$City=="PINOS-PUENTE","City"]<-"PINOS PUENTE"
fueldata[fueldata$Province=="GUADALAJARA" & fueldata$City=="MOLINA","City"]<-"MOLINA DE ARAGON"
fueldata[fueldata$Province=="HUELVA" & fueldata$City=="ISLA-CRISTINA","City"]<-"ISLA CRISTINA"
fueldata[fueldata$Province=="HUELVA" & fueldata$City=="VILLANUEVA CASTILLEJOS","City"]<-"VILLANUEVA DE LOS CASTILLEJOS"
fueldata[fueldata$Province=="HUESCA" & fueldata$City=="AINSA","City"]<-"AINSA-SOBRARBE"
fueldata[fueldata$Province=="HUESCA" & fueldata$City=="CANFRANC-ESTACION","City"]<-"CANFRANC"
fueldata[fueldata$Province=="HUESCA" & fueldata$City=="ESTOPINAN","City"]<-"ESTOPINAN DEL CASTILLO"
fueldata[fueldata$Province=="JAEN" & fueldata$City=="BEDMAR","City"]<-"BEDMAR Y GARCIEZ"
fueldata[fueldata$Province=="LLEIDA" & fueldata$City=="GIMENELLS","City"]<-"GIMENELLS I EL PLA DE LA FONT"
fueldata[fueldata$Province=="LLEIDA" & fueldata$City=="MONTFERRER","City"]<-"MONTFERRER I CASTELLBO"
fueldata[fueldata$Province=="LLEIDA" & fueldata$City=="PRATS","City"]<-"PRATS I SANSOR"
fueldata[fueldata$Province=="LLEIDA" & fueldata$City=="VIELHA","City"]<-"VIELHA E MIJARAN"
fueldata[fueldata$Province=="LUGO" & fueldata$City=="BARREIROS (CASCO URBANO)","City"]<-"BARREIROS"
fueldata[fueldata$Province=="LUGO" & fueldata$City=="LOURENZA (CASCO URBANO)","City"]<-"LOURENZA"
fueldata[fueldata$Province=="LUGO" & fueldata$City=="PASTORIZA","City"]<-"PASTORIZA, A"
fueldata[fueldata$Province=="MADRID" & fueldata$City=="ARGANDA","City"]<-"ARGANDA DEL REY"
fueldata[fueldata$Province=="MADRID" & fueldata$City=="HORCAJO DE LA SIERRA","City"]<-"HORCAJO DE LA SIERRA-AOSLOS"
fueldata[fueldata$Province=="MADRID" & fueldata$City=="LOZOYUELA","City"]<-"LOZOYUELA-NAVAS-SIETEIGLESIAS"
fueldata[fueldata$Province=="MADRID" & fueldata$City=="ORUSCO","City"]<-"ORUSCO DE TAJUNA"
fueldata[fueldata$Province=="MALAGA" & fueldata$City=="ARROYO DE LA MIEL-BENALMADENA COSTA","City"]<-"BENALMADENA"
fueldata[fueldata$Province=="MALAGA" & fueldata$City=="VILLANUEVA CONCEPCION","City"]<-"VILLANUEVA DE LA CONCEPCION"
fueldata[fueldata$Province=="MURCIA" & fueldata$City=="FUENTE ALAMO","City"]<-"FUENTE ALAMO DE MURCIA"
fueldata[fueldata$Province=="NAVARRA" & fueldata$City=="ANSOAIN","City"]<-"ANSOAIN/ANTSOAIN"
fueldata[fueldata$Province=="NAVARRA" & fueldata$City=="BARANAIN","City"]<-"BARANAIN/BARANAIN"
fueldata[fueldata$Province=="NAVARRA" & fueldata$City=="BERA / VERA DE BIDASOA","City"]<-"BERA"
fueldata[fueldata$Province=="NAVARRA" & fueldata$City=="ESTELLA O LIZARRA","City"]<-"ESTELLA-LIZARRA"
fueldata[fueldata$Province=="NAVARRA" & fueldata$City=="ETXARRI-ARANATZ","City"]<-"ETXARRI ARANATZ"
fueldata[fueldata$Province=="NAVARRA" & fueldata$City=="HUARTE","City"]<-"HUARTE/UHARTE"
fueldata[fueldata$Province=="NAVARRA" & fueldata$City=="NOAIN","City"]<-"NOAIN (VALLE DE ELORZ)/NOAIN (ELORTZIBAR)"
fueldata[fueldata$Province=="NAVARRA" & fueldata$City=="ORCOYEN","City"]<-"ORKOIEN"
fueldata[fueldata$Province=="NAVARRA" & fueldata$City=="ORONZ","City"]<-"ORONZ/ORONTZE"
fueldata[fueldata$Province=="NAVARRA" & fueldata$City=="PERALTA","City"]<-"PERALTA/AZKOIEN"
fueldata[fueldata$Province=="NAVARRA" & fueldata$City=="SANGUESA","City"]<-"SANGUESA/ZANGOZA"
fueldata[fueldata$Province=="NAVARRA" & fueldata$City=="TIEBAS","City"]<-"TIEBAS-MURUARTE DE RETA"
fueldata[fueldata$Province=="NAVARRA" & fueldata$City=="URDAZUBI / URDAX","City"]<-"URDAZUBI/URDAX"
fueldata[fueldata$Province=="NAVARRA" & fueldata$City=="URZAINQUI","City"]<-"URZAINQUI/URZAINKI"
fueldata[fueldata$Province=="NAVARRA" & fueldata$City=="VILLAVA O ATARRABIA","City"]<-"VILLAVA/ATARRABIA"
fueldata[fueldata$Province=="OURENSE" & fueldata$City=="A MEZQUITA","City"]<-"MEZQUITA, A"
fueldata[fueldata$Province=="OURENSE" & fueldata$City=="AVION, OURENSE","City"]<-"AVION"
fueldata[fueldata$Province=="OURENSE" & fueldata$City=="BARCO, O","City"]<-"BARCO DE VALDEORRAS, O"
fueldata[fueldata$Province=="OURENSE" & fueldata$City=="CARBALLINO","City"]<-"CARBALLINO, O"
fueldata[fueldata$Province=="OURENSE" & fueldata$City=="CASTRO DE CALDELAS, O","City"]<-"CASTRO CALDELAS"
fueldata[fueldata$Province=="OURENSE" & fueldata$City=="ENTRIMO, CAPITAL","City"]<-"ENTRIMO"
fueldata[fueldata$Province=="OURENSE" & fueldata$City=="NOGUEIRA","City"]<-"NOGUEIRA DE RAMUIN"
fueldata[fueldata$Province=="OURENSE" & fueldata$City=="POBRA DE TRIVES","City"]<-"POBRA DE TRIVES, A"
fueldata[fueldata$Province=="PALENCIA" & fueldata$City=="OSORNO","City"]<-"OSORNO LA MAYOR"
fueldata[fueldata$Province=="PALMAS, LAS" & fueldata$City=="EL CALERO-TELDE","City"]<-"TELDE"
fueldata[fueldata$Province=="PALMAS, LAS" & fueldata$City=="SAN BARTOLOME TIRAJANA","City"]<-"SAN BARTOLOME DE TIRAJANA"
fueldata[fueldata$Province=="PALMAS, LAS" & fueldata$City=="SANTA LUCIA","City"]<-"SANTA LUCIA DE TIRAJANA"
fueldata[fueldata$Province=="PALMAS, LAS" & fueldata$City=="COSTA TEGUISE","City"]<-"TEGUISE"
fueldata[fueldata$Province=="PALMAS, LAS" & fueldata$City=="VILLA DE TEGUISE","City"]<-"TEGUISE"
fueldata[fueldata$Province=="PONTEVEDRA" & fueldata$City=="CERDEDO","City"]<-"CERDEDO-COTOBADE"
fueldata[fueldata$Province=="PONTEVEDRA" & fueldata$City=="PAZOS","City"]<-"PAZOS DE BORBEN"
fueldata[fueldata$Province=="PONTEVEDRA" & fueldata$City=="PONTECALDELAS","City"]<-"PONTE CALDELAS"
fueldata[fueldata$Province=="RIOJA, LA" & fueldata$City=="CUZCURRITA-RIO TIRON","City"]<-"CUZCURRITA DE RIO TIRON"
fueldata[fueldata$Province=="SALAMANCA" & fueldata$City=="FRESNO-ALHANDIGA","City"]<-"FRESNO ALHANDIGA"
fueldata[fueldata$Province=="SANTA CRUZ DE TENERIFE" & fueldata$City=="ARICO NUEVO","City"]<-"ARICO"
fueldata[fueldata$Province=="SANTA CRUZ DE TENERIFE" & fueldata$City=="BRENA","City"]<-"BRENA BAJA"
fueldata[fueldata$Province=="SANTA CRUZ DE TENERIFE" & fueldata$City=="FUENCALIENTE","City"]<-"FUENCALIENTE DE LA PALMA"
fueldata[fueldata$Province=="SANTA CRUZ DE TENERIFE" & fueldata$City=="PINAR, EL","City"]<-"PINAR DE EL HIERRO, EL"
fueldata[fueldata$Province=="SANTA CRUZ DE TENERIFE" & fueldata$City=="SAN MIGUEL","City"]<-"SAN MIGUEL DE ABONA"
fueldata[fueldata$Province=="SANTA CRUZ DE TENERIFE" & fueldata$City=="TEGUESTE CENTRO","City"]<-"TEGUESTE"
fueldata[fueldata$Province=="SANTA CRUZ DE TENERIFE" & fueldata$City=="VALVERDE","City"]<-"VALVERDE DEL HIERRO"
fueldata[fueldata$Province=="SANTA CRUZ DE TENERIFE" & fueldata$City=="VILAFLOR","City"]<-"VILAFLOR DE CHASNA"
fueldata[fueldata$Province=="SEGOVIA" & fueldata$City=="FUENTESAUCO FUENTIDUENA","City"]<-"FUENTESAUCO DE FUENTIDUENA"
fueldata[fueldata$Province=="SEVILLA" & fueldata$City=="CASTILBLANCO ARROYOS","City"]<-"CASTILBLANCO DE LOS ARROYOS"
fueldata[fueldata$Province=="SEVILLA" & fueldata$City=="CASTILLO DE LAS GUARDAS","City"]<-"CASTILLO DE LAS GUARDAS, EL"
fueldata[fueldata$Province=="SEVILLA" & fueldata$City=="HUEVAR","City"]<-"HUEVAR DEL ALJARAFE"
fueldata[fueldata$Province=="SEVILLA" & fueldata$City=="LANTEJUELA, LA","City"]<-"LANTEJUELA"
fueldata[fueldata$Province=="SEVILLA" & fueldata$City=="NAVAS DE LA CONCEPCION","City"]<-"NAVAS DE LA CONCEPCION, LAS"
fueldata[fueldata$Province=="SEVILLA" & fueldata$City=="PALACIOS Y VILLAFRANCA","City"]<-"PALACIOS Y VILLAFRANCA, LOS"
fueldata[fueldata$Province=="SEVILLA" & fueldata$City=="PUEBLA DE LOS INFANTES","City"]<-"PUEBLA DE LOS INFANTES, LA"
fueldata[fueldata$Province=="SEVILLA" & fueldata$City=="VALENCINA CONCEPCION","City"]<-"VALENCINA DE LA CONCEPCION"
fueldata[fueldata$Province=="SEVILLA" & fueldata$City=="VILLANUEVA RIO Y MINAS","City"]<-"VILLANUEVA DEL RIO Y MINAS"
fueldata[fueldata$Province=="SORIA" & fueldata$City=="BURGO DE OSMA, EL","City"]<-"BURGO DE OSMA-CIUDAD DE OSMA"
fueldata[fueldata$Province=="TARRAGONA" & fueldata$City=="HOSPITALET DE L'INFANT","City"]<-"VANDELLOS I L'HOSPITALET DE L'INFANT"
fueldata[fueldata$Province=="TARRAGONA" & fueldata$City=="LA RAPITA","City"]<-"SANT CARLES DE LA RAPITA"
fueldata[fueldata$Province=="TARRAGONA" & fueldata$City=="RODA DE BARA","City"]<-"RODA DE BERA"
fueldata[fueldata$Province=="TARRAGONA" & fueldata$City=="SANT PERE I SANT PAU","City"]<-"TARRAGONA"
fueldata[fueldata$Province=="TARRAGONA" & fueldata$City=="VANDELLOS","City"]<-"VANDELLOS I L'HOSPITALET DE L'INFANT"
fueldata[fueldata$Province=="TOLEDO" & fueldata$City=="CALZADA DE OROPESA, LA","City"]<-"CALZADA DE OROPESA"
fueldata[fueldata$Province=="TOLEDO" & fueldata$City=="SESENA NUEVO","City"]<-"SESENA"
fueldata[fueldata$Province=="TOLEDO" & fueldata$City=="TORRE ESTEBAN HAMBRAN","City"]<-"TORRE DE ESTEBAN HAMBRAN, LA"
fueldata[fueldata$Province=="VALENCIA/VALENCIA" & fueldata$City=="ALBORAYA","City"]<-"ALBORAIA/ALBORAYA"
fueldata[fueldata$Province=="VALENCIA/VALENCIA" & fueldata$City=="ALGIMIA DE ALFARA","City"]<-"ALGIMIA D'ALFARA"
fueldata[fueldata$Province=="VALENCIA/VALENCIA" & fueldata$City=="BELLREGUARD POBLE","City"]<-"BELLREGUARD"
fueldata[fueldata$Province=="VALENCIA/VALENCIA" & fueldata$City=="BENISANO","City"]<-"BENISSANO"
fueldata[fueldata$Province=="VALENCIA/VALENCIA" & fueldata$City=="GENOVES","City"]<-"GENOVES, EL"
fueldata[fueldata$Province=="VALENCIA/VALENCIA" & fueldata$City=="LLOSA DE RANES","City"]<-"LLOSA DE RANES, LA"
fueldata[fueldata$Province=="VALENCIA/VALENCIA" & fueldata$City=="MASALAVES","City"]<-"MASSALAVES"
fueldata[fueldata$Province=="VALENCIA/VALENCIA" & fueldata$City=="MONSERRAT","City"]<-"MONTSERRAT"
fueldata[fueldata$Province=="VALENCIA/VALENCIA" & fueldata$City=="MONTROY","City"]<-"MONTROI/MONTROY"
fueldata[fueldata$Province=="VALENCIA/VALENCIA" & fueldata$City=="NAQUERA","City"]<-"NAQUERA/NAQUERA"
fueldata[fueldata$Province=="VALENCIA/VALENCIA" & fueldata$City=="PUIG","City"]<-"PUIG DE SANTA MARIA, EL"
fueldata[fueldata$Province=="VALENCIA/VALENCIA" & fueldata$City=="RAFELBUNOL","City"]<-"RAFELBUNYOL"
fueldata[fueldata$Province=="VALENCIA/VALENCIA" & fueldata$City=="REAL DE GANDIA","City"]<-"REAL DE GANDIA, EL"
fueldata[fueldata$Province=="VALENCIA/VALENCIA" & fueldata$City=="SAGUNTO","City"]<-"SAGUNTO/SAGUNT"
fueldata[fueldata$Province=="VALENCIA/VALENCIA" & fueldata$City=="VILLALONGA","City"]<-"VILALLONGA/VILLALONGA"
fueldata[fueldata$Province=="ZAMORA" & fueldata$City=="CORRALES","City"]<-"CORRALES DEL VINO"
fueldata[fueldata$Province=="ZARAGOZA" & fueldata$City=="VILLAMAYOR","City"]<-"VILLAMAYOR DE GALLEGO"
```

S'integren els dos *datasets* amb l'objectiu d'obtenir un únic *dataset* resultant que contingui tota la informació combinada. Aquesta integració es realitza de manera completa (all = TRUE), per tal de garantir que les dades que no tenen una parella en l'altre *dataset* es mantenen afegint *NA* en la informació.

```{r}
total<-merge(fueldata, pobdata, by=c("Province", "City"), all = TRUE)
```

Finalment, i per acabar amb les tasques de selecció es seleccionen les dades:

* del dia 16 de Novembre
* els combustibles
  + Gasóleo A habitual
  + Gasolina 95 E5

```{r}
data<-total[total$Capture_date == as.Date("2022/11/16", format ="%Y/%m/%d"),]
data<-data[data$Fuel_type == "Gasóleo A habitual" | data$Fuel_type == "Gasolina 95 E5",]
```

## 3. Neteja de dades

Com a primer pas en la neteja de dades, es procedeix a eliminar tots aquells registres del *dataset* resultant on el camp *Capture_date* sigui *NA*. Aquests seran municipis que apareixen en el cens de població, però no tenen benzinera. Aquests han aparegut en el *dataset* quan s'ha realitzat l'operació de combinació plena o *FULL JOINT* en el pas anterior.

```{r}
data<-data[!is.na(data$Capture_date),]
```

Actualment el *dataset* conté `r nrow(data)` registres, dels quals `r nrow(data[!is.na(data$Capture_date) & is.na(data$P_code),])` són registres dels quals no se'n coneix el cens. Això representa un `r round((nrow(data[!is.na(data$Capture_date) & is.na(data$P_code),]))/(nrow(data)),2)*100`% del total de registres.

Quan es procedeix a realitzar aquest mateix estudi per a cada una de les províncies amb l'objectiu d'identificar aquelles que tinguin una representació més pobre s'obté el següent gràfic en el que es marquen en verd, aquelles províncies amb un percentatge de NA inferior a 5%, en blau les províncies amb un percentatge entre 5 i 10% i en vermell aquelles províncies amb un percentatge de NA superior al 10%.

```{r echo=FALSE, fig.height=4.8, warning=FALSE}
DT<-data.table(data)
DT<-DT[, lapply(.SD, function(x) 100*(sum(is.na(x))/((sum(is.na(x)))+(sum(!is.na(x)))))),
       by = Province]
DT<-DT[,c("Province", "Population")]
p<-ggplot(data=DT, aes(x=Province, y=Population,
                       fill=ifelse(Population<5,mypalette[3],
                                   ifelse(Population>10, mypalette[2],
                                          mypalette[1])))) +
  geom_bar(stat="identity") +
  labs(y="NA percent [%]") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        legend.position = 'none')
p
```

Conseqüentment, per a estudis relacionats només amb el preu es pot utilitzar el *dataset* complert, tanmateix quan l'estudi contingui informació poblacional, aquest per raons de representativitat es limitarà a les províncies anteriorment identificades en verd i en blau.

### Valors extrems

```{r echo=FALSE, fig.height=5, warning=FALSE}
g1<-ggplot(data=data, aes(x=Fuel_type, y=Price, color=Fuel_type)) +
  geom_boxplot() +
  labs(title = "Fuel price", y="Price [€/l]") +
  theme(axis.text.x = element_blank(), legend.direction = "vertical", legend.position = "bottom")
g1
```
